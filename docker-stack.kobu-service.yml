version: '3.8'

# Production Docker Stack for kobu-llm-service
# Deploy with: docker stack deploy -c docker-stack.production.yml kobu-service
#
# =============================================================================
# FIREWALL SETUP - Restricting RabbitMQ Management UI to localhost
# =============================================================================
#
# Problem: Docker bypasses UFW by manipulating iptables directly via the DOCKER
# chain. Setting `ufw deny 15680` has no effect on Docker-published ports.
#
# Solution: Use the DOCKER-USER iptables chain. Docker guarantees this chain is
# processed BEFORE its own rules and never modifies it.
#
# Run these commands on the VPS (order matters - first match wins):
#
#   # Allow localhost access to management UI
#   sudo iptables -I DOCKER-USER -i lo -p tcp --dport 15680 -j ACCEPT
#
#   # Drop all other access to management UI
#   sudo iptables -I DOCKER-USER -p tcp --dport 15680 -j DROP
#
# To persist rules across reboots:
#
#   sudo apt install iptables-persistent
#   sudo netfilter-persistent save
#
# To verify rules:
#
#   sudo iptables -L DOCKER-USER -n -v
#
# To access the UI from your laptop, use SSH tunnel:
#
#   ssh -L 15680:127.0.0.1:15680 user@vps-ip
#   # Then open http://localhost:15680 in browser
#
# =============================================================================

services:
  rabbitmq:
    image: rabbitmq:3.12-management  # With management plugin on custom port
    hostname: rabbitmq
    ports:
      # AMQP port for external kobu-client connections
      - target: 5672
        published: 5672
        protocol: tcp
        mode: host
      # Management UI - localhost access only enforced via iptables DOCKER-USER chain
      - target: 15680
        published: 15680
        protocol: tcp
        mode: host
    environment:
      RABBITMQ_DEFAULT_VHOST: /
    command: >
      bash -c "
      export RABBITMQ_DEFAULT_USER=$$(cat /run/secrets/rabbitmq_user) &&
      export RABBITMQ_DEFAULT_PASS=$$(cat /run/secrets/rabbitmq_password) &&
      exec docker-entrypoint.sh rabbitmq-server
      "
    secrets:
      - rabbitmq_user
      - rabbitmq_password
    volumes:
      - rabbitmq_data:/var/lib/rabbitmq
      - ./config/rabbitmq.conf:/etc/rabbitmq/rabbitmq.conf:ro
    healthcheck:
      test: rabbitmq-diagnostics -q ping
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    networks:
      - kobu_network
    deploy:
      replicas: 1
      placement:
        constraints:
          - node.role == manager
      resources:
        limits:
          cpus: '1'
          memory: 2G
        reservations:
          cpus: '0.5'
          memory: 1G
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3
      update_config:
        parallelism: 1
        delay: 10s
    logging:
      driver: "json-file"
      options:
        max-size: "100m"
        max-file: "10"

  llm-worker:
    image: kobu-llm-worker:latest
    environment:
      # RabbitMQ connection
      RABBITMQ_HOST: rabbitmq
      RABBITMQ_PORT: 5672
      RABBITMQ_USER_FILE: /run/secrets/rabbitmq_user
      RABBITMQ_PASS_FILE: /run/secrets/rabbitmq_password

      # Worker configuration
      WORKER_ID: worker-1

      # Whisper STT Configuration
      WHISPER_MODEL: base
      WHISPER_DEVICE: cpu
      WHISPER_COMPUTE: int8
      WHISPER_LANGUAGE: nl

      # OpenAI Configuration
      OPENAI_API_KEY_FILE: /run/secrets/openai_api_key
      OPENAI_MODEL: gpt-4-turbo-preview

      # EHR Configuration
      EHR_BASE_URL_FILE: /run/secrets/ehr_base_url
      EHR_USERNAME_FILE: /run/secrets/ehr_username
      EHR_PASSWORD_FILE: /run/secrets/ehr_password
      EHR_MAX_RETRIES: 3
      EHR_RETRY_DELAY: 5

      # Storage paths
      AUDIO_STORAGE_PATH: /app/storage/audio_files
      PROCESSED_STORAGE_PATH: /app/storage/processed

      # Logging
      LOG_LEVEL: INFO
      LOG_FORMAT: json
    secrets:
      - rabbitmq_user
      - rabbitmq_password
      - openai_api_key
      - ehr_base_url
      - ehr_username
      - ehr_password
    volumes:
      - worker_storage:/app/storage
    networks:
      - kobu_network
    deploy:
      replicas: 1
      placement:
        constraints:
          - node.role == manager
      resources:
        limits:
          cpus: '2'
          memory: 4G
        reservations:
          cpus: '0.5'
          memory: 1G
      restart_policy:
        condition: on-failure
        delay: 10s
        max_attempts: 3
      update_config:
        parallelism: 1
        delay: 10s
        order: start-first
    healthcheck:
      test: ["CMD", "python", "-c", "import socket; socket.create_connection(('rabbitmq', 5672), timeout=5)"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    logging:
      driver: "json-file"
      options:
        max-size: "100m"
        max-file: "10"

volumes:
  rabbitmq_data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: /opt/data/kobu/rabbitmq
  worker_storage:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: /opt/data/kobu/worker_storage

networks:
  kobu_network:
    driver: overlay
    internal: false
    attachable: true

secrets:
  rabbitmq_user:
    external: true
  rabbitmq_password:
    external: true
  openai_api_key:
    external: true
  ehr_base_url:
    external: true
  ehr_username:
    external: true
  ehr_password:
    external: true
